name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      # í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ë² ì´ìŠ¤ (í•„ìš”ì‹œ)
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt
        
    - name: ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./frontend
      run: npm ci
      
    - name: í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
      working-directory: ./backend
      run: python create_test_data.py
      
    - name: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
      working-directory: ./backend
      run: |
        # ê¸°ë³¸ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
        python -c "import main; print('âœ… ë°±ì—”ë“œ ëª¨ë“ˆ ì„í¬íŠ¸ ì„±ê³µ')"
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ í…ŒìŠ¤íŠ¸
      working-directory: ./frontend
      run: npm run build
      
    - name: ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
      run: |
        chmod +x start.sh
        chmod +x stop.sh
        chmod +x test_api.sh
        chmod +x test_user_stories.sh
        chmod +x backend/start.sh
        chmod +x frontend/start.sh
        
    - name: ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
      run: |
        # ì‹œìŠ¤í…œ ì‹œì‘
        echo "ğŸš€ ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘..."
        ./start.sh &
        
        # ì„œë²„ ì‹œì‘ ëŒ€ê¸°
        echo "â³ ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
        sleep 45
        
        # ë°±ì—”ë“œ ìƒíƒœ í™•ì¸
        echo "ğŸ” ë°±ì—”ë“œ ìƒíƒœ í™•ì¸..."
        curl -f http://localhost:8080/docs || echo "âš ï¸ ë°±ì—”ë“œ ì ‘ì† ì‹¤íŒ¨"
        
        # í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ í™•ì¸  
        echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ í™•ì¸..."
        curl -f http://localhost:3000 || echo "âš ï¸ í”„ë¡ íŠ¸ì—”ë“œ ì ‘ì† ì‹¤íŒ¨"
        
        # API í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        echo "ğŸ§ª API í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        timeout 300 ./test_api.sh || echo "âš ï¸ API í…ŒìŠ¤íŠ¸ íƒ€ì„ì•„ì›ƒ"
        
        # ì‹œìŠ¤í…œ ì¢…ë£Œ
        echo "ğŸ›‘ ì‹œìŠ¤í…œ ì¢…ë£Œ..."
        ./stop.sh
        
    - name: ë¡œê·¸ ìˆ˜ì§‘
      if: always()
      run: |
        echo "ğŸ“‹ í”„ë¡œì„¸ìŠ¤ ìƒíƒœ:"
        ps aux | grep -E "(python|npm|vite)" | grep -v grep || echo "ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
        
        echo "ğŸ“‹ í¬íŠ¸ ì‚¬ìš© ìƒíƒœ:"
        netstat -tlnp | grep -E "(3000|8080)" || echo "í¬íŠ¸ ì‚¬ìš© ì—†ìŒ"
        
  docker-test:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Docker Compose í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ³ Docker Compose ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸..."
        docker-compose build
        docker-compose up -d
        
        # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
        sleep 60
        
        # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        docker-compose ps
        
        # í—¬ìŠ¤ ì²´í¬
        curl -f http://localhost:8080/docs || echo "âš ï¸ ë°±ì—”ë“œ Docker ì ‘ì† ì‹¤íŒ¨"
        curl -f http://localhost:3000 || echo "âš ï¸ í”„ë¡ íŠ¸ì—”ë“œ Docker ì ‘ì† ì‹¤íŒ¨"
        
        # ì •ë¦¬
        docker-compose down

  deploy:
    needs: [test, docker-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ë°°í¬ ì¤€ë¹„
      run: |
        echo "ğŸš€ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
        echo "í˜„ì¬ ë¸Œëœì¹˜: ${{ github.ref }}"
        echo "ì»¤ë°‹ SHA: ${{ github.sha }}"
        
        # ì—¬ê¸°ì— ì‹¤ì œ ë°°í¬ ë¡œì§ ì¶”ê°€
        # ì˜ˆì‹œ:
        # - Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ
        # - ì„œë²„ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        # - ë°°í¬ ìƒíƒœ í™•ì¸
        
        echo "âœ… ë°°í¬ ì™„ë£Œ!"
